{% extends "base.html" %}

{% block title %}Processing Email Analysis{% endblock %}
{% block header %}Analysis in Progress{% endblock %}
{% block subtitle %}Your email is being analyzed for security threats{% endblock %}

{% block content %}
<!-- Processing Status Display -->
<div class="processing-container">
    <div class="processing-spinner">
        <div class="spinner"></div>
        <h3>Analyzing Email Security</h3>
        <p>Our AI system is performing comprehensive threat analysis...</p>
        <div class="progress-steps">
            <div class="step completed">‚úì Text Processing</div>
            <div class="step active" id="ml-step">üîÑ ML Analysis</div>
            <div class="step" id="risk-step">‚è≥ Risk Assessment</div>
        </div>
    </div>
    
    <!-- Show processed text immediately -->
    <div class="immediate-results">
        <h3>Processed Email Content</h3>
        <div class="text-display">
            <pre class="email-text">{{ result }}</pre>
        </div>
        
        <div class="processing-stats">
            <div class="stat-item">
                <strong>Processing Time:</strong> {{ processing_time }}
            </div>
            <div class="stat-item">
                <strong>Input Size:</strong> {{ input_length }}
            </div>
            <div class="stat-item">
                <strong>Output Size:</strong> {{ output_length }}
            </div>
            <div class="stat-item">
                <strong>Throughput:</strong> {{ throughput }}
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh for results -->
<script>
    const sessionId = '{{ session_id }}';
    let checkCount = 0;
    const maxChecks = 30; // 30 seconds timeout
    
    function checkResults() {
        checkCount++;
        console.log(`Checking results for session ${sessionId} (attempt ${checkCount})`);
        
        // Build the URL properly
        const originalText = encodeURIComponent('{{ original_text|safe }}');
        const url = `/get_results/${sessionId}?original_text=${originalText}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('Received response, checking if analysis is complete...');
                
                // Check if we got the results page (look for unique content)
                if (html.includes('Security Analysis Results') || 
                    html.includes('risk-analysis') || 
                    html.includes('Risk Level')) {
                    console.log('Analysis complete! Redirecting to results page...');
                    
                    // Replace the entire page content
                    document.open();
                    document.write(html);
                    document.close();
                    
                    // Update the URL without reloading
                    window.history.pushState({}, '', `/get_results/${sessionId}`);
                    
                } else if (checkCount < maxChecks) {
                    // Still processing, check again
                    console.log('Still processing, checking again in 1 second...');
                    setTimeout(checkResults, 1000);
                } else {
                    // Timeout - show error
                    console.log('Analysis timeout');
                    document.querySelector('.processing-spinner h3').innerText = 'Analysis Taking Longer Than Expected';
                    document.querySelector('.processing-spinner p').innerHTML = 
                        'The analysis is taking longer than usual. You can <a href="/">try again</a> or wait a bit more.';
                    
                    // Keep trying but less frequently
                    if (checkCount < 60) { // Extended timeout to 60 seconds
                        setTimeout(checkResults, 2000);
                    }
                }
            })
            .catch(error => {
                console.error('Error checking results:', error);
                if (checkCount < maxChecks) {
                    setTimeout(checkResults, 2000); // Retry in 2 seconds on error
                } else {
                    document.querySelector('.processing-spinner h3').innerText = 'Connection Error';
                    document.querySelector('.processing-spinner p').innerHTML = 
                        'Unable to get analysis results. Please <a href="/">try again</a>.';
                }
            });
    }
    
    // Start checking for results immediately
    console.log('Starting result checking process...');
    setTimeout(checkResults, 1000);
</script>

<style>
.processing-container {
    text-align: center;
    padding: 40px 20px;
}

.processing-spinner {
    margin-bottom: 40px;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-steps {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.step {
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.step.completed {
    background: #d4edda;
    color: #155724;
}

.step.active {
    background: #fff3cd;
    color: #856404;
    animation: pulse 2s infinite;
}

.step:not(.completed):not(.active) {
    background: #e2e3e5;
    color: #6c757d;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.immediate-results {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
    margin-top: 30px;
    text-align: left;
}

.immediate-results h3 {
    margin-bottom: 20px;
    color: #495057;
}

.text-display {
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    margin-bottom: 20px;
}

.email-text {
    padding: 20px;
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 300px;
    overflow-y: auto;
    color: #495057;
}

.processing-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

@media (max-width: 768px) {
    .progress-steps {
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    
    .processing-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}